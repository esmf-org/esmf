% $Id: Perf_design.tex,v 1.6.8.3 2007/10/18 02:43:03 cdeluca Exp $
%
% Earth System Modeling Framework
% Copyright 2002-2007, University Corporation for Atmospheric Research, 
% Massachusetts Institute of Technology, Geophysical Fluid Dynamics 
% Laboratory, University of Michigan, National Centers for Environmental 
% Prediction, Los Alamos National Laboratory, Argonne National Laboratory, 
% NASA Goddard Space Flight Center.
% Licensed under the University of Illinois-NCSA License.

%\subsection{Design}

The Perf class has five high level interfaces accessible by the user:
PerfCreate, PerfStart, PerfEnd, PerfPrint, and PerfDestroy. PerfCreate does the needed
initialization, allocates needed memory, and sets the monitoring, and doHW 
flags as well as the optional PE-list synchronization. If the monitoring flag is 
set to false by the user performance monitoring 
will be turned off. If the doHW flag is set, it's value will be used as the 
default value to determine if hardware performance monitoring is done. Individual code
segments that are timed can also turn hardware monitoring on or off for
a particular code segment. PerfStart begins timing a code segment, PerfEnd
ends timing a code segment. PerfPrint prints a report on the timing results
for all code segments timed. PerfDestroy then deallocates memory that was
allocated in PerfCreate.

More information on PerfCreate. PerfCreate sets the maximum number of code-segments
that can be used (which will be increased if exceeded) and does the initial
allocates of the array of Segments. If a DE-layout is sent to PerfCreate as a
optional argument, every-time PerfStart is called a synchronization will be done
across all DE's in the DE-Layout given to PerfCreate.

More information on PerfStart. When called PerfStart figures out if the given
code segment has been activated before or not. If it hasn't it increments
the codeSegment counter and begins timing and Hardware monitoring of this
code segment. If the code segment was active before, if it's still active
it triggers an error, since this means a PerfStart has been called more than
once, without a PerfEnd imbetween. If it's not active it activates timing
for this code segment.

More information on PerfEnd. PerfEnd deactivates a code segment, and calls
the SegmentEnd method to accumulate the relevant counters.

More information on PerfPrint. PerfPrint figures out the maximum, minimum, standard-deviation
and average times across both threads and distributed DE's. The results are then 
printed to the Log file. Below we give an example printout for a case with
no threads and no distributed tasks as well as a case with threads and distributed
tasks.

Example 1, printout with no threads and no distributed tasks, and
hardware monitor turned on.
{\tt
\begin{verbatim}
Timer            Type            Value      Units
total            calls             1         #
                 wall            102.032     sec
                 cpu              64.00      sec
                 flops           640.00      Mops/sec
                 L1_cache_util    50.00      %      
                 L1_cache_miss    40.00      %      
                 L2_cache_util    30.00      %      
                 L2_cache_miss    25.00      %      
                 FPU_util         40.00      %      
                 load_store       30         %
                 cycles           90         M
initialization   calls            1          #
                 wall             2.032      sec
                 cpu              1.00       sec
                 flops          340.00       Mops/sec
                 L1_cache_util   50.00       %      
                 L1_cache_miss   30.00       %      
                 L2_cache_util   30.00       %      
                 L2_cache_miss   25.00       %      
                 FPU_util        30.00       %      
                 load_store       5          %
                 cycles           9          M
physics          calls          992
                 wall            52.032      sec
                 cpu             40.00       sec
                 flops          340.00       Mops/sec
                 L1_cache_util   50.00       %      
                 L1_cache_miss   80.00       %      
                 L2_cache_util   30.00       %      
                 L2_cache_miss   60.00       %      
                 FPU_util        20.00       %      
                 load_store      20          %
                 cycles          30          M
\end{verbatim}
}

Example 2, printout with user-threads and distributed tasks, and
hardware monitor turned off.

{\tt
\begin{verbatim}
Statistics over all DE's:

Timer            Type            Max      Avg      Min     Std-dev  Units
total            calls            1        -        -        -       #
                 wall           121.235  111.41  101.592     5.673   sec
initialization   calls            1                          -       #
                 wall             3.102    2.07    1.032     0.545   sec
physics          calls          992        -       -         -       #
                 threads          4        -       -         -       #
                 wall            60.103   45.48   30.363     3.234   sec

Statistics over DE 0 over all user threads

Timer            Type            Max      Avg      Min    Std-dev  Units
total            calls            1        -        -        -       #
                 wall           101.592    -        -        -       sec
initialization   calls            1        -        -        -       #
                 wall             1.032    -        -        -       sec
physics          calls          992        -        -        -       #
                 threads          4        -        -        -       #
                 wall            50.023   40.532   30.363    5.876   sec

Statistics over DE 1 over all user threads

Timer            Type            Max      Avg      Min      Std-dev  Units
total            calls            1        -        -        -         #
                 wall           121.235    -        -        -         sec
initialization   calls            1                          -         #
                 wall             3.102    -        -        -         sec
physics          calls          992        -        -        -         #
                 threads          4        -        -        -         #
                 wall            60.103   50.422   40.233    5.987     sec
\end{verbatim}
}


Example 3, printout with no user-threads, some DE's threaded some distributed,
hardware monitor turned off, and message information turned on.

{\tt
\begin{verbatim}
Statistics over all DE's:

Timer            Type            Max      Avg      Min     Std-dev  Units
total            calls            1        -        -        -       #
                 wall           121.235  111.41  101.592     5.673   sec
                 msgs            21       21      21         0       #
                 msgtime          4.567    5.789   3.2345    0.987   sec
initialization   calls            1                          -       #
                 wall             3.102    2.07    1.032     0.545   sec
physics          calls          992        -       -         -       #
                 wall            60.103   45.48   30.363     3.234   sec

DE 0

Timer            Type            Value    Units
total            calls            1       #
                 wall           101.592   sec
                 msgs            21       #
                 msgtime          4.567   sec
initialization   calls            1       #
                 wall             1.032   sec
physics          calls          992       #
                 wall            50.023   sec

DE 1

Timer            Type            Value    Units
total            calls            1        #
                 wall           121.235    sec
                 msgs            21       #
                 msgtime          4.567   sec
initialization   calls            1        #
                 wall             3.102    sec
physics          calls          992        #
                 wall            60.103    sec

DE 2

Timer            Type            Time     Units
total            calls            1       #
                 wall           101.592   sec
initialization   calls            1       #
                 wall             1.032   sec
physics          calls          992       #
                 wall            50.023   sec

DE 3

Timer            Type            Time     Units
total            calls            1        #
                 wall           121.235    sec
initialization   calls            1        #
                 wall             3.102    sec
physics          calls          992        #
                 wall            60.103    sec

\end{verbatim}
}
