% $Id: Perf_fex.tex,v 1.6.8.3 2007/10/18 02:43:03 cdeluca Exp $
%
% Earth System Modeling Framework
% Copyright 2002-2007, University Corporation for Atmospheric Research, 
% Massachusetts Institute of Technology, Geophysical Fluid Dynamics 
% Laboratory, University of Michigan, National Centers for Environmental 
% Prediction, Los Alamos National Laboratory, Argonne National Laboratory, 
% NASA Goddard Space Flight Center.
% Licensed under the University of Illinois-NCSA License.

%\subsection{F90 Use and Examples}

%<Detailed examples of F90 usage of the class.>

\subsubsection{Example 1. Monitor a threaded section of code}
{\tt
\begin{verbatim}
   type(ESMF_Perf) :: perf

   call ESMF_LogSet(log)
   call ESMF_LogOpenFile(ESMF_Log_World,ESMF_SINGLE_LOG_FILE,"Performance_analysis.txt")
   perf = PerfCreate(log)

   do time = 1, 9999999
!$OMP PARALELL DO PRIVATE (I)
      do i = 1, 4
         call ESMF_PerfStart( perf, 'threaded_section')
.
.
.
         call ESMF_PerfEnd( perf, 'threaded_section')
      end do
   end do
   call ESMF_PerfPrint( perf )
   call ESMF_PerfDestroy( perf )
\end{verbatim}
}
\subsubsection{Example 2. Setting the run-time option to turn timing off}
{\tt
\begin{verbatim}
   type(ESMF_Perf) :: perf

   call ESMF_LogSet(log)
   call ESMF_LogOpenFile(ESMF_Log_World,ESMF_SINGLE_LOG_FILE,"Performance_analysis.txt")
   perf = ESMF_PerfCreate( alog, monitor=.false.)

   do time = 1, 9999999
!$OMP PARALELL DO PRIVATE (I)
      do i = 1, 4
         call ESMF_PerfStart( perf, 'threaded_section')
.
.
.
         call ESMF_PerfEnd( perf, 'threaded_section')
      end do
   end do
   call ESMF_PerfPrint(perf)
   call ESMF_PerfDestroy( perf )
\end{verbatim}
}
\subsubsection{Example 3. Turning hardware monitoring on by default, but off 
for some code segments}
{\tt
\begin{verbatim}
   type(ESMF_Perf) :: perf

   call ESMF_LogSet(log)
   call ESMF_LogOpenFile(ESMF_Log_World,ESMF_SINGLE_LOG_FILE,"Performance_analysis.txt")
   perf = ESMF_PerfCreate( log, doHW=.true.)

   do time = 1, 9999999
!$OMP PARALELL DO PRIVATE (I)
      do i = 1, 4
         call ESMF_PerfStart( perf, 'threaded_section')
.
.
.
         call ESMF_PerfEnd( perf, 'threaded_section')
      end do
      call ESMF_PerfStart( perf, 'non_threaded_section', doHW=.false.)
.
.
.
      call ESMF_PerfEnd( perf, 'non_threaded_section')
   end do
   call ESMF_PerfPrint( perf )
   call ESMF_PerfDestroy( perf )
\end{verbatim}
}

\subsubsection{Example 4. Turn on timing sychronization and communication profiling}
{\tt
\begin{verbatim}
   type(ESMF_Perf)   :: perf
   type(ESMF_DEList) :: de_list

.
.
.
   call ESMF_LogSet(log)
   call ESMF_LogOpenFile(ESMF_Log_World,ESMF_SINGLE_LOG_FILE,"Performance_analysis.txt")
! At each ESMF_PerfStart and ESMF_PerfEnd, a barrier will on the given pe_list will be done
! Also sizes and times for any MPI messages between the Start and End will be output.
   perf = ESMF_PerfCreate( alog, sync_de_list=de_list, msginfo=.true. )

   do time = 1, 9999999
!$OMP PARALELL DO PRIVATE (I)
      do i = 1, 4
         call ESMF_PerfStart( perf, 'threaded_section')
.
.
.
         call ESMF_PerfEnd( perf, 'threaded_section')
      end do
   end do
   call ESMF_PerfPrint( perf )
   call ESMF_PerfDestroy( perf )
\end{verbatim}
