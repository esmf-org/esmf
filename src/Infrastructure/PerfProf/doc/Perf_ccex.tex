% $Id: Perf_ccex.tex,v 1.3.8.3 2007/10/18 02:43:02 cdeluca Exp $
%
% Earth System Modeling Framework
% Copyright 2002-2007, University Corporation for Atmospheric Research, 
% Massachusetts Institute of Technology, Geophysical Fluid Dynamics 
% Laboratory, University of Michigan, National Centers for Environmental 
% Prediction, Los Alamos National Laboratory, Argonne National Laboratory, 
% NASA Goddard Space Flight Center.
% Licensed under the University of Illinois-NCSA License.

%\subsection{C++ Use and Examples}

%<Detailed examples of F90 usage of the class.>

\subsubsection{Example 1. Monitor a threaded section of code}
{\tt
\begin{verbatim}
   ESMC_Perf  perf;

   perf = ESMC_PerfCreate();

   for( time = 0; time <=10000000; time++ ) {
#pragma omp parallel for
      for( i = 0, i < 4; i++ ) {

#pragma omp critical

        {
           perf.ESMC_PerfStart( 'threaded_section');
.
.
.
           perf.ESMC_PerfEnd( 'threaded_section');
        }
     }
  }
  perf.ESMC_PerfPrint( );
  perf.ESMC_PerfDestroy( );
\end{verbatim}
}
\subsubsection{Example 2. Setting the run-time option to turn timing off}
{\tt
\begin{verbatim}
   ESMC_Perf  perf;

   perf = ESMC_PerfCreate( monitor=false);

   for( time = 0; time <=10000000; time++ ) {
#pragma omp parallel for
      for( i = 0, i < 4; i++ ) {

#pragma omp critical

        {
           perf.ESMC_PerfStart( 'threaded_section');
.
.
.
           perf.ESMC_PerfEnd( 'threaded_section');
        }
     }
  }
  perf.ESMC_PerfPrint( );
  perf.ESMC_PerfDestroy( );
\end{verbatim}
}
\subsubsection{Example 3. Turning hardware monitoring on by default, but off 
for some code segments}
{\tt
\begin{verbatim}
   ESMC_Perf  perf;

   perf = ESMC_PerfCreate( doHardware=true);

   for( time = 0; time <=10000000; time++ ) {
#pragma omp parallel for
      for( i = 0, i < 4; i++ ) {

#pragma omp critical

        {
           perf.ESMC_PerfStart( 'threaded_section');
.
.
.
           perf.ESMC_PerfEnd( 'threaded_section');
        }
     }
     perf.ESMC_PerfStart( 'non_threaded_section', doHW=false);
.
.
.
     perf.ESMC_PerfEnd( 'non_threaded_section');
  }
  perf.ESMC_PerfPrint( );
  perf.ESMC_PerfDestroy( );
\end{verbatim}
}

\subsubsection{Example 4. Turn on timing sychronization and communication profiling}
{\tt
\begin{verbatim}
   ESMC_Perf   perf;
   ESMC_Layout de_list;

.
.
.
// At each ESMF_PerfStart and ESMF_PerfEnd, a barrier will on the given de_list will be done
// Also sizes and times for any MPI messages between the Start and End will be output.
   msginfo = 1;
   perf = ESMC_PerfCreate( de_list, msginfo );

   for( time = 0; time <=10000000; time++ ) {
#pragma omp parallel for
      for( i = 0, i < 4; i++ ) {

#pragma omp critical

        {
           perf.ESMC_PerfStart( 'threaded_section');
.
.
.
           perf.ESMC_PerfEnd( 'threaded_section');
        }
     }
  }
  perf.ESMC_PerfPrint( );
  perf.ESMC_PerfDestroy( );
\end{verbatim}
}
